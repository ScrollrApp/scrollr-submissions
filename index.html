<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Scrollr Submission</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      * {
        box-sizing: border-box;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
      }

      body {
        margin: 0;
        padding: 16px;
        background: #020617;
        color: #e5e7eb;
      }

      .page {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      @media (min-width: 900px) {
        .page {
          flex-direction: row;
          align-items: flex-start;
        }
      }

      .column {
        flex: 1;
        min-width: 0;
      }

      h1 {
        font-size: 24px;
        margin-bottom: 8px;
      }

      .subtitle {
        font-size: 14px;
        color: #9ca3af;
        margin-bottom: 16px;
      }

      form {
        background: #020617;
        padding: 16px;
        border-radius: 12px;
        border: 1px solid #1f2937;
      }

      label {
        display: block;
        font-size: 13px;
        margin-bottom: 4px;
        color: #e5e7eb;
      }

      .field {
        margin-bottom: 12px;
      }

      input[type="text"],
      textarea {
        width: 100%;
        padding: 8px 10px;
        border-radius: 8px;
        background: #020617;
        border: 1px solid #4b5563;
        color: #e5e7eb;
        font-size: 14px;
      }

      input[type="text"]:focus,
      textarea:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 1px #6366f1;
      }

      textarea {
        min-height: 120px;
        resize: vertical;
      }

      .small-hint {
        font-size: 11px;
        color: #9ca3af;
        margin-top: 2px;
      }

      button[type="submit"] {
        margin-top: 8px;
        padding: 10px 16px;
        border-radius: 999px;
        border: none;
        background: #6366f1;
        color: white;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
      }

      button[type="submit"]:hover {
        filter: brightness(1.1);
      }

      .slide-controls {
        display: flex;
        gap: 8px;
        margin: 12px 0 4px;
        align-items: center;
        flex-wrap: wrap;
      }

      .slide-btn {
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid #4b5563;
        background: #020617;
        color: #e5e7eb;
        font-size: 12px;
        cursor: pointer;
      }

      .slide-btn:hover {
        border-color: #6366f1;
      }

      .slides-note {
        font-size: 11px;
        color: #9ca3af;
      }

      .slide-section {
        border-radius: 10px;
        border: 1px solid #1f2937;
        padding: 12px;
        margin-bottom: 12px;
        background: #020617;
      }

      .slide-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }

      .slide-title-text {
        font-size: 13px;
        font-weight: 600;
        color: #e5e7eb;
      }

      .slide-required {
        font-size: 11px;
        color: #f97316;
        margin-left: 4px;
      }

      .slide-tag {
        font-size: 11px;
        color: #9ca3af;
      }

      /* Preview side */

      .preview-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
      }

      .phone-frame {
        width: 360px;
        max-width: 100%;
        border-radius: 28px;
        background: #020617;
        border: 2px solid #111827;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.7);
        overflow: hidden;
      }

      .post-container {
        position: relative;
        min-height: 540px;
        padding-top: 10px;
        padding-bottom: calc(45px + 40px); /* action row offset + padding */
        padding-left: 16px;
        padding-right: 16px;
        display: flex;
        flex-direction: column;
      }

      .post-content {
        flex: 1;
      }

      .post-title {
        font-size: 20px;
        font-weight: 700;
        color: #f9fafb;
        margin-bottom: 6px;
      }

      .post-author {
        font-size: 12px;
        color: #9ca3af;
        margin-bottom: 4px;
      }

      .slide-indicator {
        font-size: 11px;
        color: #9ca3af;
        margin-bottom: 8px;
      }

      .image-wrapper {
        position: relative;
        margin-bottom: 10px;
      }

      .post-image {
        width: 100%;
        height: 140px;
        object-fit: cover;
        border-radius: 10px;
        visibility: hidden; /* hidden until a valid src exists */
      }

      .image-credit {
        position: absolute;
        bottom: 6px;
        right: 8px;
        font-size: 10px;
        color: rgba(249, 250, 251, 0.9);
        background-color: rgba(0, 0, 0, 0.5);
        padding: 1px 4px;
        border-radius: 4px;
      }

      .image-credit.hidden {
        display: none;
      }

      .image-wrapper.hidden {
        display: none;
      }

      .post-body {
        font-size: 14px;
        line-height: 20px;
        color: #e5e7eb;
        margin-bottom: 6px;
        white-space: pre-line;
        word-break: break-word;
        overflow-wrap: break-word;
      }

      .actions-row {
        position: absolute;
        bottom: 45px; /* matches ACTION_ROW_OFFSET */
        left: 16px;
        right: 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(to top, rgba(15, 23, 42, 0.95), transparent);
        padding: 8px 10px;
        border-radius: 999px;
      }

      .read-more-btn {
        padding: 6px 14px;
        border-radius: 999px;
        border: 1px solid #f97316;
        background: transparent;
        font-size: 14px;
        font-weight: 600;
        color: #f97316;
      }

      .right-actions {
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .action-button {
        padding: 4px 6px;
        font-size: 14px;
        font-weight: 500;
        color: #e5e7eb;
      }

      .preview-caption {
        font-size: 12px;
        color: #9ca3af;
        text-align: center;
        max-width: 360px;
      }

      .preview-dots {
        position: absolute;
        bottom: 18px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 6px;
        align-items: center;
        justify-content: center;
        pointer-events: auto;
      }

      .preview-dot {
        width: 6px;
        height: 6px;
        border-radius: 999px;
        background: #4b5563;
        cursor: pointer;
        transition: width 0.15s ease, background 0.15s ease;
      }

      .preview-dot.active {
        background: #f9fafb;
        width: 12px;
      }

      .json-preview-wrapper {
        margin-top: 12px;
        border-radius: 10px;
        border: 1px solid #1f2937;
        padding: 8px;
        background: #020617;
      }

      .json-preview-title {
        font-size: 12px;
        color: #9ca3af;
        margin-bottom: 4px;
      }

      .json-preview-textarea {
        width: 100%;
        min-height: 120px;
        background: #020617;
        border-radius: 8px;
        border: 1px solid #4b5563;
        color: #e5e7eb;
        font-size: 11px;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        padding: 6px 8px;
        resize: vertical;
      }
    </style>
  </head>
  <body>
    <div class="page">
      <!-- LEFT: FORM -->
      <div class="column">
        <h1>Submit a Scrollr Post</h1>
        <div class="subtitle">
          Fill in the fields; the preview on the right updates live to match the app.
          Multi-slide posts are encouraged: use Slide 1 for a short summary and later
          slides for more detail.
        </div>

        <form id="submission-form">
          <div class="field">
            <label for="title">Title</label>
            <input
              type="text"
              id="title"
              placeholder="How to Submit a Scrollr Post"
              required
            />
          </div>

          <div class="field">
            <label for="authorName">Author</label>
            <input
              type="text"
              id="authorName"
              placeholder="You"
              required
            />
          </div>

          <div class="field">
            <label for="category">Category</label>
            <input
              type="text"
              id="category"
              placeholder="Teaching / Physics / Philosophy..."
              required
            />
            <div class="small-hint">
              Shown as "Author · Category" under the title.
            </div>
          </div>

          <div class="slide-controls">
            <button type="button" id="add-slide" class="slide-btn">
              + Add slide
            </button>
            <button type="button" id="remove-slide" class="slide-btn">
              − Remove last slide
            </button>
            <span class="slides-note" id="slides-count-label">
              Currently 1 slide (Slide 1 is required; extra slides are optional).
            </span>
          </div>

          <div id="slides-container"></div>

          <div class="field">
            <label for="globalReadMore">Default "Read more" URL (optional)</label>
            <input
              type="text"
              id="globalReadMore"
              placeholder="https://example.com/article"
            />
            <div class="small-hint">
              If a slide’s own “Read more” URL is empty, this default will be used
              instead.
            </div>
          </div>

          <button type="submit">Open email with JSON submission</button>
          <div class="small-hint">
            Submission opens your email client (to <b>scrollrapp@gmail.com</b>) with a
            pre-filled JSON body. Check it and hit send.
          </div>

          <div class="json-preview-wrapper">
            <div class="json-preview-title">
              JSON preview (this is what will be emailed)
            </div>
            <textarea
              id="json-preview"
              class="json-preview-textarea"
              readonly
            ></textarea>
          </div>
        </form>
      </div>

      <!-- RIGHT: PREVIEW -->
      <div class="column">
        <div class="preview-wrapper">
          <div class="phone-frame">
            <div class="post-container">
              <div class="post-content">
                <h2 id="preview-title" class="post-title">
                  Your title goes here
                </h2>
                <div id="preview-author" class="post-author">
                  Author · Category
                </div>
                <div id="preview-slide-indicator" class="slide-indicator">
                  Slide 1 / 1
                </div>

                <div class="image-wrapper">
                  <img
                    id="preview-image"
                    class="post-image"
                    alt="Preview"
                  />
                  <div id="preview-credit" class="image-credit hidden">
                    credit: someone
                  </div>
                </div>

                <div id="preview-body" class="post-body">
                  Start typing your slides on the left. This area shows roughly how
                  much text fits comfortably on one slide.
                </div>
              </div>

              <div class="actions-row">
                <button id="preview-readmore" class="read-more-btn">
                  Read more
                </button>

                <div class="right-actions">
                  <div class="action-button" id="preview-like">
                    ♡ Like
                  </div>
                  <div class="action-button" id="preview-save">
                    ☆ Save
                  </div>
                </div>
              </div>

              <div id="preview-dots" class="preview-dots"></div>
            </div>
          </div>
          <div class="preview-caption">
            This uses the same general composition and bottom action row offset as
            your Scrollr PostCard. Click the dots to preview different slides.
          </div>
        </div>
      </div>
    </div>

    <script>
      const MAX_SLIDES = 6;

      const titleInput = document.getElementById("title");
      const authorNameInput = document.getElementById("authorName");
      const categoryInput = document.getElementById("category");
      const globalReadMoreInput = document.getElementById("globalReadMore");
      const slidesContainer = document.getElementById("slides-container");
      const slidesCountLabel = document.getElementById("slides-count-label");
      const addSlideBtn = document.getElementById("add-slide");
      const removeSlideBtn = document.getElementById("remove-slide");
      const jsonPreview = document.getElementById("json-preview");

      const previewTitle = document.getElementById("preview-title");
      const previewAuthor = document.getElementById("preview-author");
      const previewBody = document.getElementById("preview-body");
      const previewImage = document.getElementById("preview-image");
      const previewCredit = document.getElementById("preview-credit");
      const previewDots = document.getElementById("preview-dots");
      const previewSlideIndicator = document.getElementById(
        "preview-slide-indicator"
      );

      const form = document.getElementById("submission-form");

      let slideCount = 0;
      let currentSlideIndex = 0; // 0-based index

      function createSlideSection(index) {
        const section = document.createElement("div");
        section.className = "slide-section";
        section.dataset.slideIndex = index.toString();

        const header = document.createElement("div");
        header.className = "slide-header";

        const leftHeader = document.createElement("div");
        const titleSpan = document.createElement("span");
        titleSpan.className = "slide-title-text";
        titleSpan.textContent = `Slide ${index + 1}`;
        leftHeader.appendChild(titleSpan);

        if (index === 0) {
          const reqSpan = document.createElement("span");
          reqSpan.className = "slide-required";
          reqSpan.textContent = "required";
          leftHeader.appendChild(reqSpan);
        } else {
          const tag = document.createElement("span");
          tag.className = "slide-tag";
          tag.textContent = "detail / follow-up slide (optional)";
          leftHeader.appendChild(tag);
        }

        header.appendChild(leftHeader);
        section.appendChild(header);

        // Body
        const bodyField = document.createElement("div");
        bodyField.className = "field";

        const bodyLabel = document.createElement("label");
        bodyLabel.textContent = "Body text";
        bodyLabel.htmlFor = `slide-${index}-body`;
        bodyField.appendChild(bodyLabel);

        const bodyTextarea = document.createElement("textarea");
        bodyTextarea.id = `slide-${index}-body`;
        bodyTextarea.placeholder =
          index === 0
            ? "Short, self-contained summary of the concept..."
            : "More detailed explanation, examples, or follow-up points...";
        if (index === 0) bodyTextarea.required = true;
        bodyField.appendChild(bodyTextarea);

        const bodyHint = document.createElement("div");
        bodyHint.className = "small-hint";
        bodyHint.textContent = "Aim for ~50–150 words per slide.";
        bodyField.appendChild(bodyHint);

        section.appendChild(bodyField);

        // Image URL
        const imageField = document.createElement("div");
        imageField.className = "field";
        const imageLabel = document.createElement("label");
        imageLabel.textContent = "Image URL (optional)";
        imageLabel.htmlFor = `slide-${index}-image`;
        imageField.appendChild(imageLabel);

        const imageInput = document.createElement("input");
        imageInput.type = "text";
        imageInput.id = `slide-${index}-image`;
        imageInput.placeholder = "https://images.unsplash.com/...";
        imageField.appendChild(imageInput);

        const imageHint = document.createElement("div");
        imageHint.className = "small-hint";
        imageHint.textContent =
          "Use a direct image link. The preview hides the image if the URL fails to load.";
        imageField.appendChild(imageHint);

        section.appendChild(imageField);

        // Credit
        const creditField = document.createElement("div");
        creditField.className = "field";
        const creditLabel = document.createElement("label");
        creditLabel.textContent = "Image credit (optional)";
        creditLabel.htmlFor = `slide-${index}-credit`;
        creditField.appendChild(creditLabel);

        const creditInput = document.createElement("input");
        creditInput.type = "text";
        creditInput.id = `slide-${index}-credit`;
        creditInput.placeholder = "Unsplash / photographer / source";
        creditField.appendChild(creditInput);

        const creditHint = document.createElement("div");
        creditHint.className = "small-hint";
        creditHint.textContent =
          "Shown on the bottom-right of the image if filled in.";
        creditField.appendChild(creditHint);

        section.appendChild(creditField);

        // Read more URL for this slide
        const readMoreField = document.createElement("div");
        readMoreField.className = "field";
        const readMoreLabel = document.createElement("label");
        readMoreLabel.textContent = 'Read more URL (optional for this slide)';
        readMoreLabel.htmlFor = `slide-${index}-readmore`;
        readMoreField.appendChild(readMoreLabel);

        const readMoreInput = document.createElement("input");
        readMoreInput.type = "text";
        readMoreInput.id = `slide-${index}-readmore`;
        readMoreInput.placeholder = "Leave empty to use default URL above";
        readMoreField.appendChild(readMoreInput);

        section.appendChild(readMoreField);

        // Attach listeners
        [bodyTextarea, imageInput, creditInput, readMoreInput].forEach((el) => {
          el.addEventListener("input", () => {
            updatePreview();
            updateJsonPreview();
          });
        });

        return section;
      }

      function ensureAtLeastOneSlide() {
        if (slideCount === 0) {
          addSlide();
        }
      }

      function addSlide() {
        if (slideCount >= MAX_SLIDES) return;
        const section = createSlideSection(slideCount);
        slidesContainer.appendChild(section);
        slideCount += 1;
        if (slideCount === 1) {
          currentSlideIndex = 0;
        }
        updateSlidesCountLabel();
        updatePreview();
        updateJsonPreview();
      }

      function removeSlide() {
        if (slideCount <= 1) return; // keep at least one slide
        const last = slidesContainer.querySelector(
          '.slide-section[data-slide-index="' + (slideCount - 1) + '"]'
        );
        if (last) {
          slidesContainer.removeChild(last);
        }
        slideCount -= 1;
        if (currentSlideIndex >= slideCount) {
          currentSlideIndex = slideCount - 1;
        }
        updateSlidesCountLabel();
        updatePreview();
        updateJsonPreview();
      }

      function updateSlidesCountLabel() {
        slidesCountLabel.textContent = `Currently ${slideCount} slide${
          slideCount === 1 ? "" : "s"
        } (Slide 1 is required; extra slides are optional).`;
      }

      function getSlidesData() {
        const slides = [];
        for (let i = 0; i < slideCount; i++) {
          const bodyEl = document.getElementById(`slide-${i}-body`);
          const imageEl = document.getElementById(`slide-${i}-image`);
          const creditEl = document.getElementById(`slide-${i}-credit`);
          const readMoreEl = document.getElementById(`slide-${i}-readmore`);

          slides.push({
            body: bodyEl ? bodyEl.value.trim() : "",
            imageUrl: imageEl ? imageEl.value.trim() : "",
            creditCompany: creditEl ? creditEl.value.trim() : "",
            readMoreUrl: readMoreEl ? readMoreEl.value.trim() : "",
          });
        }
        return slides;
      }

      function updatePreview() {
        const wrapper = document.querySelector(".image-wrapper");

        // Title
        const title = titleInput.value.trim();
        previewTitle.textContent = title || "Your title goes here";

        // Author + Category
        const authorName = authorNameInput.value.trim();
        const category = categoryInput.value.trim();

        if (authorName && category) {
          previewAuthor.textContent = `${authorName} · ${category}`;
        } else if (authorName) {
          previewAuthor.textContent = authorName;
        } else if (category) {
          previewAuthor.textContent = category;
        } else {
          previewAuthor.textContent = "Author · Category";
        }

        // Slides data
        const slides = getSlidesData();

        if (slides.length === 0) {
          // No slides at all
          previewBody.textContent =
            "Start typing your slides on the left. This area shows roughly how much text fits comfortably on one slide.";
          previewImage.style.visibility = "hidden";
          previewCredit.classList.add("hidden");
          previewSlideIndicator.textContent = "Slide 1 / 1";
          if (wrapper) wrapper.classList.add("hidden");
          renderDots(1);
          return;
        }

        // Clamp current slide index
        const index = Math.min(Math.max(currentSlideIndex, 0), slides.length - 1);
        currentSlideIndex = index;
        const slide = slides[index];

        previewSlideIndicator.textContent = `Slide ${index + 1} / ${slides.length}`;

        // Body text for this slide
        previewBody.textContent =
          slide.body ||
          "This slide is currently empty. Add text for the body in the form on the left.";

        // IMAGE + WRAPPER VISIBILITY **PER SLIDE**
        if (slide.imageUrl) {
          // This slide has an image → show wrapper & image
          if (wrapper) wrapper.classList.remove("hidden");

          if (previewImage.src !== slide.imageUrl) {
            previewImage.src = slide.imageUrl;
          }
          previewImage.style.visibility = "visible";

          if (slide.creditCompany) {
            previewCredit.textContent = "credit: " + slide.creditCompany;
            previewCredit.classList.remove("hidden");
          } else {
            previewCredit.classList.add("hidden");
          }
        } else {
          // This slide has NO image → remove wrapper so text moves up
          if (wrapper) wrapper.classList.add("hidden");
          previewImage.style.visibility = "hidden";
          previewCredit.classList.add("hidden");
        }

        // Update slide dots
        renderDots(slides.length);
      }

      function renderDots(count) {
        previewDots.innerHTML = "";
        for (let i = 0; i < count; i++) {
          const dot = document.createElement("div");
          dot.className = "preview-dot" + (i === currentSlideIndex ? " active" : "");
          dot.dataset.dotIndex = i.toString();
          previewDots.appendChild(dot);
        }
      }

      // Hide image if URL is broken
      previewImage.addEventListener("error", () => {
        previewImage.style.visibility = "hidden";
      });

      previewDots.addEventListener("click", (e) => {
        const target = e.target;
        if (target.classList.contains("preview-dot")) {
          const idx = parseInt(target.dataset.dotIndex, 10);
          if (!Number.isNaN(idx)) {
            currentSlideIndex = idx;
            updatePreview();
          }
        }
      });

      function buildJson() {
        const title = titleInput.value.trim();
        const author = authorNameInput.value.trim();
        const category = categoryInput.value.trim();
        const slides = getSlidesData();
        const defaultReadMore = globalReadMoreInput.value.trim();

        // Fill missing readMoreUrl with default if present
        const slidesWithReadMore = slides.map((s) => ({
          body: s.body,
          imageUrl: s.imageUrl || undefined,
          readMoreUrl: s.readMoreUrl || defaultReadMore || undefined,
          creditCompany: s.creditCompany || undefined,
        }));

        const post = {
          title,
          author,
          category,
          slides: slidesWithReadMore,
        };

        return post;
      }

      function updateJsonPreview() {
        const obj = buildJson();
        // Avoid dumping totally empty structure
        if (!obj.title && !obj.author && !obj.category && !obj.slides[0].body) {
          jsonPreview.value = "// JSON will appear here as you fill the form.";
          return;
        }
        jsonPreview.value = JSON.stringify(obj, null, 2);
      }

      function handleSubmit(event) {
        event.preventDefault();

        if (!form.reportValidity()) {
          return;
        }

        const obj = buildJson();
        const subjectBase =
          (obj.title || "Scrollr submission") +
          (obj.author ? " – " + obj.author : "");
        const subject = encodeURIComponent(subjectBase);
        const bodyLines = [
          "Scrollr submission JSON:",
          "",
          JSON.stringify(obj, null, 2),
          "",
          "——",
          "Sent from the Scrollr submission page.",
        ];
        const body = encodeURIComponent(bodyLines.join("\n"));

        const mailto = `mailto:scrollrapp@gmail.com?subject=${subject}&body=${body}`;
        window.location.href = mailto;
      }

      // Global listeners
      [titleInput, authorNameInput, categoryInput, globalReadMoreInput].forEach(
        (el) =>
          el.addEventListener("input", () => {
            updatePreview();
            updateJsonPreview();
          })
      );

      addSlideBtn.addEventListener("click", addSlide);
      removeSlideBtn.addEventListener("click", removeSlide);
      form.addEventListener("submit", handleSubmit);

      // Initial setup
      ensureAtLeastOneSlide();
      updatePreview();
      updateJsonPreview();
    </script>
  </body>
</html>

